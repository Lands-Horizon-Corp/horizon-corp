import { toast } from 'sonner'
import { useState, forwardRef } from 'react'

import { Button } from '@/components/ui/button'
import ImageDisplay from '@/components/image-display'
import { ImageIcon, TrashIcon, XIcon } from '@/components/icons'
import { SingleImageUploaderModal } from '@/components/uploaders/single-image-uploader'

import { formatBytes } from '@/helpers'
import { IMediaResource, TEntityId } from '@/server'
import { IconType } from 'react-icons/lib'
import { abbreviateUUID } from '@/utils/formatting-utils'

export interface SingleBigImageUploadFieldProps {
    id?: string
    name?: string
    DisplayIcon?: IconType
    value?: TEntityId
    placeholder?: string
    mediaImage?: IMediaResource | undefined
    onChange?: (media: IMediaResource | undefined) => void
}

export const SingleBigImageUploadField = forwardRef<
    HTMLButtonElement,
    SingleBigImageUploadFieldProps
>(
    (
        {
            value,
            mediaImage,
            placeholder,
            DisplayIcon = ImageIcon,
            onChange,
            ...other
        },
        ref
    ) => {
        const [uploaderModal, setUploaderModal] = useState(false)

        return (
            <div className="min-h-36">
                <SingleImageUploaderModal
                    title="Upload Image"
                    description="Choose/Upload single image. You may also capture using camera."
                    open={uploaderModal}
                    onOpenChange={setUploaderModal}
                    singleImageUploaderProp={{
                        onSuccess: (media: IMediaResource) => {
                            toast.success(
                                `Image Uploaded ${media.fileName} with ID: ${media.id}`
                            )
                            onChange?.({
                                ...media,
                                id: '550e8400-e29b-41d4-a716-446655440000',
                            })
                            setUploaderModal(false)
                        },
                        className: 'p-0',
                    }}
                    className="max-w-xl bg-popover p-8"
                />
                {mediaImage ? (
                    <div className="relative flex flex-col items-center justify-center gap-x-2 rounded-md border bg-background p-2 text-center">
                        <ImageDisplay
                            className="size-16 rounded-lg"
                            src={mediaImage.downloadURL}
                        />
                        <p>{mediaImage.fileName}</p>
                        <p className="text-muted-foreground/70">
                            {formatBytes(mediaImage.fileSize)}
                        </p>
                        <Button
                            size="icon"
                            type="button"
                            variant="secondary"
                            hoverVariant="destructive"
                            className="absolute right-2 top-2 size-fit p-1"
                            onClick={() => {
                                onChange?.(undefined)
                            }}
                        >
                            <XIcon />
                        </Button>
                    </div>
                ) : (
                    <Button
                        {...other}
                        ref={ref}
                        type="button"
                        role="button"
                        variant="outline"
                        onClick={() => setUploaderModal(true)}
                        className="flex size-full flex-col items-center justify-center bg-background px-3 font-normal outline-offset-0 hover:bg-background focus-visible:border-ring focus-visible:outline-[3px] focus-visible:outline-ring/20"
                    >
                        <DisplayIcon className="size-16 shrink-0 text-muted-foreground/30" />
                        {value ? (
                            <span>
                                {abbreviateUUID(value, 14)} (Uploaded Image)
                            </span>
                        ) : (
                            (placeholder ?? 'Upload Image')
                        )}
                    </Button>
                )}
            </div>
        )
    }
)

SingleBigImageUploadField.displayName = 'SingleImageUploadField'
